name: Compile

on:
  push:
    branches: [master, develop*, released]
  pull_request:
    branches: [master, develop*, released]

# Cancels all previous workflow runs for pull requests that have not completed.
concurrency:
  # The concurrency group contains the workflow name and the branch name for
  # pull requests or the commit hash for any other events.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      WEB3_CONSTANTS_RPC: ${{ secrets.WEB3_CONSTANTS_RPC }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    steps:
      - name: Get cache date
        id: get-date
        run: echo "::set-output name=date::$(/bin/date -u "+%Y%m%d")"
        shell: bash
      - uses: actions/checkout@v2
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
          cache: 'pnpm'
      - name: Authenticate NPM
        uses: DimensionDev/github-token-action@latest
        with:
            registry: true
      - name: Restore Webpack cache
        uses: actions/cache@v2
        with:
          path: packages/mask/node_modules/.cache/
          key: ext-${{ hashFiles('pnpm-lock.yaml') }}-${{ steps.get-date.outputs.date }}
          # Not fallback to different dependencies. Webpack seems like have bug.
          # An example caused by the webpack cache bug: https://github.com/facebook/react/issues/21587
          restore-keys: ext-${{ hashFiles('pnpm-lock.yaml') }}
      - run: pnpm install
      - run: npx gulp build-ci
      - name: Upload `MaskNetwork.base`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.base
          path: build
          if-no-files-found: error
      - name: Upload `MaskNetwork.iOS`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.iOS
          path: build-iOS
          if-no-files-found: error
      - name: Upload `MaskNetwork.chromium`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.chromium
          path: build
          if-no-files-found: error
      - name: Upload `MaskNetwork.chromium-beta`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.chromium-beta
          path: build-chromium-beta
          if-no-files-found: error
      - name: Upload `MaskNetwork.chromium-mv3`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.chromium-mv3
          path: build-mv3
          if-no-files-found: error
      - name: Upload `MaskNetwork.firefox`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.firefox
          path: build-firefox
          if-no-files-found: error
      - name: Upload `MaskNetwork.gecko`
        uses: actions/upload-artifact@v3
        with:
          name: MaskNetwork.gecko
          path: build-android
          if-no-files-found: error
