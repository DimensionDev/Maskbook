# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1
jobs:
    build:
        docker:
            - image: circleci/node:current
        working_directory: ~/repo
        steps:
            - checkout
            - restore_cache:
                  keys:
                      - v1-maskbook-{{ .Branch }}-{{ checksum "yarn.lock" }}
                      - v1-maskbook-{{ .Branch }}-
                      - v1-maskbook-
            - run:
                  name: Build Maskbook
                  command: |
                      yarn install --link-duplicates --frozen-lockfile
                      yarn lint:report
                      yarn build
                      sudo apt-get install zip
                      # Build base version
                      cd build
                      zip -r ../Maskbook.zip ./*
                      cd ..
                      # Build WKWebview version
                      node ./scripts/modify-manifest.js WKWebview
                      cd build
                      zip -r ../Maskbook.WKWebview.zip ./*
                      cd ..
                      # Build chromium version
                      node ./scripts/modify-manifest.js chromium
                      cd build
                      zip -r ../Maskbook.chromium.zip ./*
                      cd ..
                      # Build firefoxDesktop version
                      node ./scripts/modify-manifest.js firefoxDesktop
                      cd build
                      zip -r ../Maskbook.firefoxDesktop.zip ./*
                      cd ..
                      # Build firefoxGeckoview version
                      node ./scripts/modify-manifest.js firefoxGeckoview
                      cd build
                      zip -r ../Maskbook.firefoxGeckoview.zip ./*
                      cd ..
                      # Build firefoxAndroid version
                      node ./scripts/modify-manifest.js firefoxAndroid
                      cd build
                      zip -r ../Maskbook.firefoxAndroid.zip ./*
                      cd ..
            - save_cache:
                  paths:
                      - node_modules
                  key: v1-maskbook-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - store_artifacts:
                  path: Maskbook.zip
                  destination: /Maskbook.zip
            - store_artifacts:
                  path: Maskbook.WKWebview.zip
                  destination: /Maskbook.WKWebview.zip
            - store_artifacts:
                  path: Maskbook.chromium.zip
                  destination: /Maskbook.chromium.zip
            - store_artifacts:
                  path: Maskbook.firefoxDesktop.zip
                  destination: /Maskbook.firefoxDesktop.zip
            - store_artifacts:
                  path: Maskbook.firefoxGeckoview.zip
                  destination: /Maskbook.firefoxGeckoview.zip
            - store_artifacts:
                  path: Maskbook.firefoxAndroid.zip
                  destination: /Maskbook.firefoxAndroid.zip
            - persist_to_workspace:
                  root: ~/repo/
                  paths:
                      - Maskbook.zip
                      - Maskbook.WKWebview.zip
                      - Maskbook.chromium.zip
                      - Maskbook.firefoxDesktop.zip
                      - Maskbook.firefoxGeckoview.zip
                      - Maskbook.firefoxAndroid.zip
    publish-github-release:
        docker:
            - image: cibuilds/github:0.10
        steps:
            - checkout
            - attach_workspace:
                  at: ~/repo/
            - run:
                  name: 'Publish Release on GitHub'
                  command: |
                      set -o nounset
                      ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -b "‚úî No breaking changes. / ‚ö† Has breaking changes!

                      üÜï New Feature

                      üîê Security

                      üé® UI Improvements

                      üêõ Bug Fixes

                      üë©‚Äçüíª Miscellaneous" -replace -draft -prerelease $(git describe HEAD) ~/repo/Maskbook.zip
                  # -b BODY \         # Set text describing the contents of the release
                  # -delete \         # Delete release and its git tag in advance if it exists (same as -recreate)
                  # -n TITLE \        # Set release title
workflows:
    version: 2
    main:
        jobs:
            - build
            - publish-github-release:
                  requires:
                      - build
                  filters:
                      branches:
                          only: released
# test
